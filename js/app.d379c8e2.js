(function(t){function e(e){for(var c,s,i=e[0],r=e[1],o=e[2],b=0,d=[];b<i.length;b++)s=i[b],Object.prototype.hasOwnProperty.call(a,s)&&a[s]&&d.push(a[s][0]),a[s]=0;for(c in r)Object.prototype.hasOwnProperty.call(r,c)&&(t[c]=r[c]);u&&u(e);while(d.length)d.shift()();return l.push.apply(l,o||[]),n()}function n(){for(var t,e=0;e<l.length;e++){for(var n=l[e],c=!0,i=1;i<n.length;i++){var r=n[i];0!==a[r]&&(c=!1)}c&&(l.splice(e--,1),t=s(s.s=n[0]))}return t}var c={},a={app:0},l=[];function s(e){if(c[e])return c[e].exports;var n=c[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=c,s.d=function(t,e,n){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},s.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var c in t)s.d(n,c,function(e){return t[e]}.bind(null,c));return n},s.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="";var i=window["webpackJsonp"]=window["webpackJsonp"]||[],r=i.push.bind(i);i.push=e,i=i.slice();for(var o=0;o<i.length;o++)e(i[o]);var u=r;l.push([1,"chunk-vendors"]),n()})({0:function(t,e){},1:function(t,e,n){t.exports=n("56d7")},2:function(t,e){},3:function(t,e){},4:function(t,e){},"56d7":function(t,e,n){"use strict";n.r(e);var c=n("7a23");const a=Object(c["g"])("div",{class:"header"},[Object(c["g"])("div",{class:"item"},[Object(c["g"])("h1",null,"DAO IPCI smart building offsetting")])],-1),l={key:1,class:"loader"};function s(t,e,n,s,i,r){const o=Object(c["n"])("Page");return Object(c["k"])(),Object(c["f"])(c["a"],null,[a,i.isReady?(Object(c["k"])(),Object(c["d"])(o,{key:0})):(Object(c["k"])(),Object(c["f"])("div",l,"..."))],64)}function i(t,e,n,a,l,s){const i=Object(c["n"])("subscription"),r=Object(c["n"])("pubsub"),o=Object(c["n"])("energy");return Object(c["k"])(),Object(c["f"])("div",null,[Object(c["i"])(i,{onController:e[0]||(e[0]=t=>{l.controller=t}),class:"block"}),Object(c["i"])(r,{onListen:e[1]||(e[1]=t=>{l.pubsub=t}),class:"block"}),Object(c["i"])(o,{controller:l.controller,pubsub:l.pubsub,class:"block"},null,8,["controller","pubsub"])])}const r=["disabled","loading"],o=Object(c["g"])("div",null,[Object(c["g"])("h2",null,"Energy")],-1),u={key:0},b=Object(c["g"])("div",null,"...",-1),d={key:0},h=Object(c["g"])("h3",null,"Liability",-1),j=Object(c["g"])("b",null,"Technical",-1),O=["href"],p=Object(c["g"])("br",null,null,-1),g=Object(c["g"])("b",null,"Promisee",-1),y=Object(c["g"])("br",null,null,-1),v=Object(c["g"])("b",null,"Promisor",-1),f=Object(c["g"])("h3",null,"Report",-1),m=["href"],k={key:1},w=["href"],D=Object(c["g"])("h3",null,"Burn",-1),L=["loading"],M={key:2,class:"error"},B=Object(c["g"])("h3",null,"Energy",-1),_=["disabled"],A={key:0,class:"error"},S=Object(c["g"])("h3",null,"Energy",-1),R=Object(c["g"])("div",null,[Object(c["g"])("div",null,"not found")],-1);function H(t,e,n,a,l,s){return Object(c["k"])(),Object(c["f"])("div",null,[Object(c["g"])("div",{disabled:!n.controller,loading:l.loadDatalog||l.liability&&null===l.liability.report},[o,l.loadDatalog?(Object(c["k"])(),Object(c["f"])("div",u,[Object(c["h"])(" Load "),b])):(Object(c["k"])(),Object(c["f"])(c["a"],{key:1},[l.liability?(Object(c["k"])(),Object(c["f"])("div",d,[h,Object(c["g"])("div",null,[j,Object(c["h"])(": "),Object(c["g"])("a",{href:"https://ipfs.io/ipfs/"+l.liability.technical,target:"_blank"},Object(c["o"])(l.liability.technical),9,O),p,g,Object(c["h"])(": "+Object(c["o"])(l.liability.promisee),1),y,v,Object(c["h"])(": "+Object(c["o"])(l.liability.promisor),1)]),f,Object(c["g"])("div",null,[l.liability.reportHash?(Object(c["k"])(),Object(c["f"])("a",{key:0,href:"http://ipfs.io/ipfs/"+l.liability.reportHash,target:"_blank"},Object(c["o"])(l.liability.reportHash),9,m)):l.liability.report?(Object(c["k"])(),Object(c["f"])("a",{key:2,href:l.liability.report,target:"_blank"},Object(c["o"])(l.liability.report),9,w)):(Object(c["k"])(),Object(c["f"])("div",k,"..."))])])):l.lastBurnDate?(Object(c["k"])(),Object(c["f"])(c["a"],{key:1},[D,Object(c["g"])("div",null,[Object(c["g"])("div",null,"Last burn date: "+Object(c["o"])(l.lastBurnDate),1),Object(c["g"])("div",null,Object(c["o"])(l.kwhToBurn)+" kwh",1)]),l.isAuthorizedCrust?(Object(c["k"])(),Object(c["f"])("div",{key:1,onClick:e[1]||(e[1]=(...t)=>s.burn&&s.burn(...t)),loading:l.isLoadBurn},"Burn",8,L)):(Object(c["k"])(),Object(c["f"])("button",{key:0,onClick:e[0]||(e[0]=Object(c["u"])((...t)=>s.crustAuth&&s.crustAuth(...t),["stop","prevent"]))}," crust auth ")),l.errorBurn?(Object(c["k"])(),Object(c["f"])("div",M,Object(c["o"])(l.errorBurn),1)):Object(c["e"])("",!0)],64)):l.energy?(Object(c["k"])(),Object(c["f"])(c["a"],{key:2},[B,Object(c["g"])("div",null,[Object(c["g"])("div",null,Object(c["o"])(l.energy.energy)+" kWh",1)]),Object(c["g"])("button",{onClick:e[2]||(e[2]=(...t)=>s.request&&s.request(...t)),disabled:l.isLoadRequest},"Request",8,_),l.errorRequest?(Object(c["k"])(),Object(c["f"])("div",A,Object(c["o"])(l.errorRequest),1)):Object(c["e"])("",!0)],64)):(Object(c["k"])(),Object(c["f"])(c["a"],{key:3},[S,R],64))],64))],8,r)])}var q=n("0b67"),C=n("36ea");const P={endpoint:"ws://127.0.0.1:9944/",types:{Message:{from:"AccountId",data:"Vec<u8>"}},rpc:{pubsub:{peer:{description:"",params:[],type:"String"},listen:{description:"",params:[{name:"address",type:"String"}],type:"Bool"},listeners:{description:"",params:[],type:"Vec<String>"},connect:{description:"",params:[{name:"address",type:"String"}],type:"Bool"},subscribe:{description:"",params:[{name:"topic_name",type:"String"}],pubsub:["subscribe","subscribe","unsubscribe"],type:"Message"},unsubscribe:{description:"",params:[{name:"topic_name",type:"String"}],type:"Bool"},publish:{description:"",params:[{name:"topic_name",type:"String"},{name:"message",type:"String"}],type:"Bool"}}}};console.log(P);const U=new C["b"](P);U.setAccountManager(new C["a"](q["a"]));var N=U;const T=()=>{const t=Object(c["l"])(null);N.accountManager.account&&(t.value=N.accountManager.account.address);const e=N.accountManager.onChange(e=>{t.value=e.address});return{account:t,unsubscribe:e}};var x=n("26af"),E=n("d880"),F=n("19ef");const J="last_burn_date_query",V="last_burn_date_response",$="liability_query";var I={props:["controller","pubsub"],setup(){const{account:t,unsubscribe:e}=T();return Object(c["j"])(()=>{e()}),{account:t}},data(){return{loadDatalog:!1,energy:null,lastBurnDate:null,kwhToBurn:null,liability:null,isLoadRequest:!1,errorRequest:null,isLoadBurn:!1,errorBurn:null,isAuthorizedCrust:!1}},async created(){this.getEnergyFromDatalog()},watch:{controller(){this.getEnergyFromDatalog()}},methods:{async crustAuth(){try{const t=Object(F["a"])(this.accountManager.account.address,66),e=await this.accountManager.account.signMsg(t);this.$crust.auth(t,e),this.isAuthorizedCrust=!0}catch(t){console.log(t)}},async getEnergyFromDatalog(){if(!this.controller)return this.energy=null,this.lastBurnDate=null,void(this.kwhToBurn=null);this.loadDatalog=!0;try{const t=await N.datalog.read(Object(F["a"])(this.controller.address,32)),e=await this.$crust.catFile(t[t.length-1][1].toHuman()),n=JSON.parse(this.decrypt(e));this.energy=n.energy}catch(t){}this.loadDatalog=!1},async request(){this.isLoadRequest=!0,this.errorRequest=null,this.lastBurnDate=null,this.kwhToBurn=null;const t=N.api.rpc.pubsub.subscribe(V,e=>{try{const t=JSON.parse(e.data.toHuman());console.log(t),"None"===t.last_burn_date?this.lastBurnDate="-":this.lastBurnDate=t.last_burn_date,this.kwhToBurn=t.kwh_to_burn}catch(n){console.log(n,e.data.toHuman())}this.isLoadRequest=!1,t.then(t=>{t()})}),e=await N.api.rpc.pubsub.publish(J,JSON.stringify({datetime:Date.now(),address:this.account,kwh_current:this.energy.energy}));console.log("pubsub publish",e.toHuman()),e.toHuman()||(this.errorRequest="Error: Message not sent",this.isLoadRequest=!1,t.then(t=>{t()}))},async burn(){this.isLoadBurn=!0,this.errorBurn=null;const t=await this.$crust.add(JSON.stringify({geo:this.energy.geo,kwh:this.energy.energy}),"burn"),e=C["c"].cidToHex(t),n=0,c=await this.signData(e,n),a=await N.liability.on({},t=>{for(const e of t)if("NewLiability"===e.event)console.log("NewLiability",e.data),e.data.promisee===Object(F["a"])(this.controller.address,32)&&(this.isLoadBurn=!1,this.liability={...e.data,technical:C["c"].hexToCid(e.data.technical),report:null,reportHash:null},console.log("liability",this.liability));else if("NewReport"===e.event&&(console.log("NewReport",e.data),e.data.index===this.liability.index&&e.data.sender===this.liability.promisor)){this.isLoadBurn=!1;const t=C["c"].hexToCid(e.data.payload);this.$crust.catFile(t).then(e=>{try{console.log(e),this.liability.report=e.burn_transaction_hash}catch(n){console.log(n),this.liability.reportHash=t}}).catch(()=>{this.liability.reportHash=t}),a()}});console.log(JSON.stringify({datetime:Date.now(),technics:t,economics:n,promisee:Object(F["a"])(this.controller.address,32),promisee_signature:{[this.controller.type.toUpperCase()]:c}}));const l=await N.api.rpc.pubsub.publish($,JSON.stringify({datetime:Date.now(),technics:t,economics:n,promisee:Object(F["a"])(this.controller.address,32),promisee_signature:{[this.controller.type.toUpperCase()]:c}}));console.log("pubsub publish",l.toHuman()),l.toHuman()||(this.errorBurn="Error: Message not sent",this.isLoadBurn=!1,a())},async signData(t,e){const{data:n}=N.liability.getDataLiability(t,e);return Object(x["a"])(await this.controller.sign(n))},decrypt(t){const e=this.controller.decryptMessage(t,this.controller.publicKey);return Object(E["a"])(e)}}},z=n("6b0d"),W=n.n(z);const K=W()(I,[["render",H]]);var Y=K;const G=Object(c["g"])("div",null,[Object(c["g"])("h2",null,"Pubsub")],-1),Q=Object(c["g"])("div",null,"Connect multiaddr",-1),X=Object(c["g"])("div",null,"Listen multiaddr",-1),Z={key:1,class:"success"};function tt(t,e,n,a,l,s){return Object(c["k"])(),Object(c["f"])("div",null,[Object(c["g"])("div",null,[G,Object(c["g"])("div",null,[Q,Object(c["g"])("div",null,[Object(c["t"])(Object(c["g"])("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>l.connectMultiaddr=t),type:"text"},null,512),[[c["q"],l.connectMultiaddr]])])]),Object(c["g"])("div",null,[X,Object(c["g"])("div",null,[Object(c["t"])(Object(c["g"])("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>l.listenMultiaddr=t),type:"text"},null,512),[[c["q"],l.listenMultiaddr]])]),Object(c["g"])("div",null,[l.isListen?(Object(c["k"])(),Object(c["f"])("div",Z,"Ok")):(Object(c["k"])(),Object(c["f"])("button",{key:0,onClick:e[2]||(e[2]=(...t)=>s.listen&&s.listen(...t))},"listen"))])])])])}var et={emits:["listen"],data(){return{listenMultiaddr:"/ip4/127.0.0.1/tcp/44440",connectMultiaddr:"/ip4/127.0.0.1/tcp/44441",isListen:!1}},watch:{multiaddrLocal(){this.listen()},multiaddr(){this.connect()},isListen(){this.$emit("listen",this.isListen)}},created(){this.listen(),this.connect()},methods:{async checkListen(){const t=await N.api.rpc.pubsub.listeners(),e=t.toHuman();return console.log("pubsub listeners",e,e.includes(this.listenMultiaddr)),e.includes(this.listenMultiaddr)},async listen(){if(await this.checkListen())return void(this.isListen=!0);const t=await N.api.rpc.pubsub.listen(this.listenMultiaddr);console.log("pubsub listen",this.listenMultiaddr,t.toHuman()),await this.checkListen()?this.isListen=!0:(this.isListen=!1,console.log("no subs"))},async connect(){try{const t=await N.api.rpc.pubsub.connect(this.connectMultiaddr);console.log("pubsub connect",this.connectMultiaddr,t.toHuman())}catch(t){console.log("pubsub connect",this.connectMultiaddr,t.message)}}}};const nt=W()(et,[["render",tt]]);var ct=nt;const at=Object(c["g"])("div",null,[Object(c["g"])("h2",null,"Your subscription")],-1),lt=Object(c["g"])("h3",null,"Account",-1),st={key:0,class:"success"},it={key:1,class:"error"},rt=Object(c["g"])("h3",null,"Controller",-1),ot=Object(c["g"])("label",null,"Account:",-1),ut=["value"],bt=Object(c["g"])("label",null,"Seed phrase to encrypt data:",-1),dt={key:0,class:"error"};function ht(t,e,n,a,l,s){const i=Object(c["n"])("Account");return Object(c["k"])(),Object(c["f"])("div",null,[Object(c["g"])("div",null,[at,Object(c["g"])("div",null,[lt,Object(c["i"])(i),a.subscription.isActive.value?(Object(c["k"])(),Object(c["f"])("div",st," Subscription active till "+Object(c["o"])(a.subscription.validUntilFormat.value),1)):(Object(c["k"])(),Object(c["f"])("div",it,"No active subsription"))]),Object(c["g"])("div",null,[rt,Object(c["g"])("div",null,[ot,Object(c["t"])(Object(c["g"])("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.controller=t)},[(Object(c["k"])(!0),Object(c["f"])(c["a"],null,Object(c["m"])(a.devices,(t,e)=>(Object(c["k"])(),Object(c["f"])("option",{key:e,value:t.address},Object(c["o"])(t.address.substr(0,5))+"..."+Object(c["o"])(t.address.substr(-5)),9,ut))),128))],512),[[c["p"],a.controller]])]),Object(c["g"])("div",null,[bt,Object(c["t"])(Object(c["g"])("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>a.seed=t),type:"password"},null,512),[[c["q"],a.seed]])]),a.seed&&!s.validateUri?(Object(c["k"])(),Object(c["f"])("div",dt,"Wrong seed phrase")):Object(c["e"])("",!0)])])])}const jt=t=>{const e=Object(c["l"])([]),n=async t=>{const n=await N.rws.getDevices(t);e.value=n.map(t=>({name:"",address:t.toHuman()}))};return Object(c["s"])(async()=>{await n(t.value)}),{devices:e,loadDevices:n}};var Ot=n("8d9d");const pt=async t=>{const e=await N.rws.getLedger(t);if(!e.isEmpty)return e.value},gt=864e5,yt=async t=>{const e=await N.rws.getDevices(t);return e.isEmpty?[]:e.map(t=>t.toHuman())},vt=async(t,e)=>{const n=await yt(t);return!!n.includes(e)},ft=(t=null)=>{const e=Object(c["l"])(t),n=Object(c["l"])(null),a=Object(c["b"])(()=>{if(null===n.value)return"";const t=n.value.issueTime.toNumber();let e=0;return n.value.kind.isDaily&&(e=n.value.kind.value.days.toNumber()),t+e*gt}),l=Object(c["b"])(()=>null===n.value?"-":new Date(a.value).toLocaleDateString()),s=Object(c["b"])(()=>{if(null===n.value)return 0;let t=0;return n.value.kind.isDaily&&(t=n.value.kind.value.days.toNumber()),t/30}),i=Object(c["b"])(()=>!(null===n.value||Date.now()>a.value)),r=async()=>{console.log("loadLedger",e.value);try{Object(Ot["a"])(e.value);const t=await pt(e.value);if(t)return console.log("test"),n.value=t,void console.log("print",n.value.toHuman())}catch(t){}n.value=null};Object(c["r"])(e,async()=>{console.log("watch",e.value),await r()},{immediate:!0});const o=async t=>await vt(e.value,t);return{owner:e,subscription:n,isActive:i,countMonth:s,validUntil:a,validUntilFormat:l,hasDevice:o,loadLedger:r}};var mt=n("e4fd");const kt=["value"],wt=Object(c["g"])("br",null,null,-1),Dt=Object(c["g"])("br",null,null,-1);function Lt(t,e,n,a,l,s){return Object(c["k"])(),Object(c["f"])("div",null,[Object(c["h"])(" Account: "),l.isReady?(Object(c["k"])(),Object(c["f"])(c["a"],{key:0},[Object(c["t"])(Object(c["g"])("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>l.account=t)},[(Object(c["k"])(!0),Object(c["f"])(c["a"],null,Object(c["m"])(l.accounts,(t,e)=>{var n;return Object(c["k"])(),Object(c["f"])("option",{key:e,value:t.address},Object(c["o"])(t.meta.isTesting?"dev":"")+" "+Object(c["o"])(t.meta.name)+" | "+Object(c["o"])(null===(n=t.meta)||void 0===n?void 0:n.source),9,kt)}),128))],512),[[c["p"],l.account]]),wt,Object(c["h"])(" "+Object(c["o"])(l.account)+" ",1),Dt,Object(c["h"])(" Balance: "+Object(c["o"])(s.balancePrint),1)],64)):(Object(c["k"])(),Object(c["f"])("button",{key:1,onClick:e[1]||(e[1]=(...t)=>s.connect&&s.connect(...t))},"connect")),Object(c["g"])("p",null,Object(c["o"])(l.error),1)])}var Mt=n("1349"),Bt={data(){return{isReady:!1,account:null,accounts:[],unsubscribe:null,balance:"",error:""}},created(){this.connect(),N.accountManager.onReady(()=>{this.isReady=!0,console.log("allow"),console.log("polkadot-js",C["a"].checkAllow("polkadot-js")),console.log("talisman",C["a"].checkAllow("talisman")),console.log("subwallet-js",C["a"].checkAllow("subwallet-js"))}),setTimeout(()=>{console.log("installed"),console.log("polkadot-js",C["a"].checkInstalled("polkadot-js")),console.log("talisman",C["a"].checkInstalled("talisman")),console.log("subwallet-js",C["a"].checkInstalled("subwallet-js"))},1e3)},computed:{balancePrint(){return Object(Mt["a"])(this.balance,{decimals:N.api.registry.chainDecimals[0],withUnit:N.api.registry.chainTokens[0]})}},watch:{async account(t){this.unsubscribe&&this.unsubscribe(),await N.accountManager.selectAccountByAddress(t),this.unsubscribe=await N.account.getBalance(t,t=>{this.balance=t.free.sub(t.feeFrozen)})}},methods:{async connect(){this.error="";try{await C["a"].initPlugin(N.accountManager.keyring,{}),this.accounts=N.accountManager.getAccounts(),this.accounts.length&&(this.account=this.accounts[0].address)}catch(t){this.error=t.message}}}};const _t=W()(Bt,[["render",Lt]]);var At=_t,St={components:{Account:At},setup(){const t=Object(c["l"])(""),e=Object(c["l"])(""),{account:n,unsubscribe:a}=T();Object(c["j"])(()=>{a()});const l=ft(n),{devices:s,loadDevices:i}=jt(n);return Object(c["r"])(s,()=>{s.value.length?t.value=s.value[0].address:t.value=""}),{controller:t,seed:e,account:n,subscription:l,devices:s,loadDevices:i}},emits:["controller"],computed:{controllerAccount(){if(this.seed)try{const t=new mt["a"];return t.addFromUri(this.seed,{},"ed25519")}catch(t){console.log(t)}return null},validateUri(){return!(!this.controllerAccount||!this.controller||Object(F["a"])(this.controller)!==Object(F["a"])(this.controllerAccount.address))}},watch:{validateUri:{immediate:!0,handler(){this.validateUri?this.$emit("controller",this.controllerAccount):this.$emit("controller",null)}}}};const Rt=W()(St,[["render",ht]]);var Ht=Rt,qt={components:{Subscription:Ht,Pubsub:ct,Energy:Y},data(){return{controller:null,pubsub:!1}}};const Ct=W()(qt,[["render",i]]);var Pt=Ct,Ut={components:{Page:Pt},data(){return{isReady:!1}},async created(){await N.run(),this.isReady=!0}};n("bdeb");const Nt=W()(Ut,[["render",s]]);var Tt=Nt;Object(c["c"])(Tt).mount("#app")},adce:function(t,e,n){},bdeb:function(t,e,n){"use strict";n("adce")}});
//# sourceMappingURL=app.d379c8e2.js.map