(function(){var t={566:function(t,e,n){"use strict";var i=n(5361),a=n(9242),r=n(3396);const o=(0,r._)("div",{class:"header"},[(0,r._)("div",{class:"item"},[(0,r._)("h1",null,"DAO IPCI smart building offsetting")])],-1),s={key:1,class:"loader"};function c(t,e,n,i,a,c){const u=(0,r.up)("Page");return(0,r.wg)(),(0,r.iD)(r.HY,null,[o,a.isReady?((0,r.wg)(),(0,r.j4)(u,{key:0})):((0,r.wg)(),(0,r.iD)("div",s,"..."))],64)}function u(t,e,n,i,a,o){const s=(0,r.up)("account"),c=(0,r.up)("pubsub"),u=(0,r.up)("energy");return(0,r.wg)(),(0,r.iD)("div",null,[(0,r.Wm)(s,{class:"block"}),(0,r.Wm)(c),(0,r.Wm)(u,{class:"block"})])}var l=n(7139);const d=["value"],p=(0,r._)("br",null,null,-1),h=["disabled"];function g(t,e,n,i,o,s){return(0,r.wg)(),(0,r.iD)("div",null,[o.isReady?((0,r.wg)(),(0,r.iD)(r.HY,{key:0},[(0,r.wy)((0,r._)("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>o.account=t)},[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(o.accounts,((t,e)=>((0,r.wg)(),(0,r.iD)("option",{key:e,value:t.address},(0,l.zw)(t.meta.isTesting?"dev":"")+" "+(0,l.zw)(t.meta.name)+" | "+(0,l.zw)(t.meta?.source),9,d)))),128))],512),[[a.bM,o.account]]),p,(0,r.Uk)(" "+(0,l.zw)(o.account),1)],64)):((0,r.wg)(),(0,r.iD)("button",{key:1,onClick:e[1]||(e[1]=(...t)=>s.connect&&s.connect(...t)),disabled:o.connectionProgress},[o.connectionProgress?((0,r.wg)(),(0,r.iD)(r.HY,{key:1},[(0,r.Uk)("connect ...")],64)):((0,r.wg)(),(0,r.iD)(r.HY,{key:0},[(0,r.Uk)("connect")],64))],8,h)),(0,r._)("p",null,(0,l.zw)(o.error),1)])}var b=n(5),y=n(3057),f=n(9044),m=n(7541),w=n(6117);function _(){return new Promise((function(t,e){const n=setTimeout((()=>(clearTimeout(n),clearInterval(i),e(new Error("Not fount polkadot.extension")))),3e3),i=setInterval((()=>{if(Object.keys(window.injectedWeb3).length>0)return clearTimeout(n),clearInterval(i),t()}),100)}))}let v=[];class k extends f.Uk{constructor(t,e=null){super(t,e)}static async initPlugin(t,e={}){if(await _(),v=await(0,m.$y)("robonomics"),0===v.length)throw new Error("Allow the browser extension to interact with dapp and try again.");const n=await(0,m.vK)(),i=n.map((({address:t,meta:e})=>({address:t,meta:e})));t.loadAll({...e},i),f.Uk.setReady(!0)}get extensions(){return v}static checkInstalled(t){var e,n;return!(null===(e=window)||void 0===e||null===(n=e.injectedWeb3)||void 0===n||!n[t])}static checkAllow(t){return v.findIndex((e=>e.name===t))>=0}async mixin(){if(this.account.meta.isInjected){const t=await(0,m.R0)(this.account.meta.source);this.api.setSigner(t.signer),this.account.signMsg=async e=>(await t.signer.signRaw({address:this.account.address,data:(0,w.c)(e),type:"bytes"})).signature}else this.account.signMsg=async t=>Promise.resolve((0,w.c)(this.account.sign(t)))}}const D={endpoint:"wss://kusama.rpc.robonomics.network/",types:{Message:{from:"AccountId",data:"Vec<u8>"}},rpc:{pubsub:{peer:{description:"",params:[],type:"String"},listen:{description:"",params:[{name:"address",type:"String"}],type:"Bool"},listeners:{description:"",params:[],type:"Vec<String>"},connect:{description:"",params:[{name:"address",type:"String"}],type:"Bool"},subscribe:{description:"",params:[{name:"topic_name",type:"String"}],pubsub:["subscribe","subscribe","unsubscribe"],type:"Message"},unsubscribe:{description:"",params:[{name:"topic_name",type:"String"}],type:"Bool"},publish:{description:"",params:[{name:"topic_name",type:"String"},{name:"message",type:"String"}],type:"Bool"}}}};console.log(D);const O=new f.l(D);O.setAccountManager(new k(y.ZP));var T=O,M={data(){return{isReady:!1,account:null,accounts:[],unsubscribe:null,balance:"",error:"",connectionProgress:!1}},created(){this.connect(),T.accountManager.onReady((()=>{this.isReady=!0,this.connectionProgress=!1}))},computed:{balancePrint(){return(0,b.a)(this.balance,{decimals:T.api.registry.chainDecimals[0],withUnit:T.api.registry.chainTokens[0]})}},watch:{async account(t){this.unsubscribe&&this.unsubscribe(),await T.accountManager.selectAccountByAddress(t),this.unsubscribe=await T.account.getBalance(t,(t=>{this.balance=t.free.sub(t.feeFrozen)})),this.$ipfs.authClear()}},methods:{async connect(){this.connectionProgress=!0,this.error="";try{await k.initPlugin(T.accountManager.keyring,{isDevelopment:!1}),this.accounts=T.accountManager.getAccounts(),this.accounts.length&&(this.account=this.accounts[0].address)}catch(t){this.error=t.message,this.connectionProgress=!1}}}},P=n(89);const B=(0,P.Z)(M,[["render",g]]);var R=B;const A={key:0},S={key:0},C=(0,r._)("h3",null,"Liability",-1),U=(0,r._)("b",null,"Technical",-1),L=["href"],H=(0,r._)("br",null,null,-1),E=(0,r._)("b",null,"Promisee",-1),I=(0,r._)("br",null,null,-1),N=(0,r._)("b",null,"Promisor",-1),z=(0,r._)("h3",null,"Report",-1),j=["href"],q={key:1},x=["href"],Y=(0,r._)("h3",null,"Burn",-1),$=["loading"],W={key:2,class:"error"},J=(0,r._)("h3",null,"Energy",-1),V=["disabled"],Z={key:0,class:"error"};function Q(t,e,n,i,o,s){return o.isAccount?((0,r.wg)(),(0,r.iD)("div",A,[o.liability?((0,r.wg)(),(0,r.iD)("div",S,[C,(0,r._)("div",null,[U,(0,r.Uk)(": "),(0,r._)("a",{href:`https://ipfs.io/ipfs/${o.liability.technical}`,target:"_blank"},(0,l.zw)(o.liability.technical),9,L),H,E,(0,r.Uk)(": "+(0,l.zw)(o.liability.promisee),1),I,N,(0,r.Uk)(": "+(0,l.zw)(o.liability.promisor),1)]),z,(0,r._)("div",null,[o.liability.reportHash?((0,r.wg)(),(0,r.iD)("a",{key:0,href:`http://ipfs.io/ipfs/${o.liability.reportHash}`,target:"_blank"},(0,l.zw)(o.liability.reportHash),9,j)):o.liability.report?((0,r.wg)(),(0,r.iD)("a",{key:2,href:"https://robonomics.polkaholic.io/tx/{liability.report}",target:"_blank"},(0,l.zw)(o.liability.report),9,x)):((0,r.wg)(),(0,r.iD)("div",q,"..."))])])):o.lastBurnDate?((0,r.wg)(),(0,r.iD)(r.HY,{key:1},[Y,(0,r._)("div",null,[(0,r._)("div",null,"Last compensation date: "+(0,l.zw)(o.lastBurnDate),1),(0,r._)("div",null,(0,l.zw)(o.kwhToBurn)+" kwh",1)]),o.isAuthorizedCrust?((0,r.wg)(),(0,r.iD)(r.HY,{key:1},[(0,r._)("div",null,[(0,r._)("div",null,[(0,r.Uk)("geo: "),(0,r.wy)((0,r._)("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>o.geo=t)},null,512),[[a.nr,o.geo]])])]),(0,r._)("button",{onClick:e[2]||(e[2]=(...t)=>s.burn&&s.burn(...t)),loading:o.isLoadBurn},"Compensation",8,$)],64)):((0,r.wg)(),(0,r.iD)("button",{key:0,onClick:e[0]||(e[0]=(0,a.iM)(((...t)=>s.ipfsAuth&&s.ipfsAuth(...t)),["stop","prevent"]))}," ipfs auth ")),o.errorBurn?((0,r.wg)(),(0,r.iD)("div",W,(0,l.zw)(o.errorBurn),1)):(0,r.kq)("",!0)],64)):((0,r.wg)(),(0,r.iD)(r.HY,{key:2},[J,(0,r._)("div",null,[(0,r._)("div",null,[(0,r.wy)((0,r._)("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>o.energy=t)},null,512),[[a.nr,o.energy]]),(0,r.Uk)(" kWh")])]),(0,r._)("button",{onClick:e[4]||(e[4]=(...t)=>s.request&&s.request(...t)),disabled:o.isLoadRequest},"Request",8,V),o.errorRequest?((0,r.wg)(),(0,r.iD)("div",Z,(0,l.zw)(o.errorRequest),1)):(0,r.kq)("",!0)],64))])):(0,r.kq)("",!0)}var F=n(2273),G=n(9330),K={LAST_BURN_DATE_QUERY_TOPIC:"last_compensation_date_query",LAST_BURN_DATE_RESPONSE_TOPIC:"last_compensation_date_response",LIABILITY_QUERY_TOPIC:"liability_query",CONNECT_MULTIADDR:"/dns/robonomics.rpc.multi-agent.io/tcp/44440",GATEWAY:"https://ipfs-gateway.multi-agent.io"},X={data(){return{energy:10,geo:"",lastBurnDate:null,kwhToBurn:null,liability:null,isLoadRequest:!1,errorRequest:null,isLoadBurn:!1,errorBurn:null,isAccount:!1,isAuthorizedCrust:!1}},created(){T.accountManager.onReady((()=>{this.isAccount=!0})),T.accountManager.onChange((()=>{this.isAuthorizedCrust=!1}))},methods:{async ipfsAuth(){try{const t=(await T.accountManager.account.signMsg((0,F.d)(T.accountManager.account.address))).toString();this.$ipfs.auth(T.accountManager.account.address,t),this.isAuthorizedCrust=!0}catch(t){console.log(t)}},async request(){this.isLoadRequest=!0,this.errorRequest=null,this.lastBurnDate=null,this.kwhToBurn=null;const t=T.api.rpc.pubsub.subscribe(K.LAST_BURN_DATE_RESPONSE_TOPIC,(e=>{try{const t=JSON.parse(e.data.toHuman());"None"===t.last_compensation_date?this.lastBurnDate="-":this.lastBurnDate=t.last_compensation_date,this.kwhToBurn=t.kwh_to_compensate}catch(n){console.log(n,e.data.toHuman())}this.isLoadRequest=!1,t.then((t=>{t()}))})),e=await T.api.rpc.pubsub.publish(K.LAST_BURN_DATE_QUERY_TOPIC,JSON.stringify({timestamp:Date.now(),address:T.accountManager.account.address,kwh_current:this.energy}));console.log("pubsub publish",e.toHuman()),e.toHuman()||(this.errorRequest="Error: Message not sent",this.isLoadRequest=!1,t.then((t=>{t()})))},async burn(){this.isLoadBurn=!0,this.errorBurn=null;const t=await this.$ipfs.add(JSON.stringify({geo:this.geo,kwh:this.energy})),e=f.P6.cidToHex(t),n=0,i=await this.signData(e,n),a=await T.liability.on({},(t=>{for(const e of t)if("NewLiability"===e.event)console.log("NewLiability",e.data),e.data.promisee===(0,G.m)(T.accountManager.account.address,32)&&(this.isLoadBurn=!1,this.liability={...e.data,technical:f.P6.hexToCid(e.data.technical),report:null,reportHash:null},console.log("liability",this.liability));else if("NewReport"===e.event&&(console.log("NewReport",e.data),e.data.index===this.liability.index&&e.data.sender===this.liability.promisor)){this.isLoadBurn=!1;const t=f.P6.hexToCid(e.data.payload);this.$ipfs.cat(t).then((e=>{try{console.log(e),this.liability.report=e.burn_transaction_hash}catch(n){console.log(n),this.liability.reportHash=t}})).catch((()=>{this.liability.reportHash=t})),a()}}));console.log(JSON.stringify({timestamp:Date.now(),technics:t,economics:n,promisee:(0,G.m)(T.accountManager.account.address,32),promisee_signature:{[T.accountManager.account.type.toUpperCase()]:i}}));const r=await T.api.rpc.pubsub.publish(K.LIABILITY_QUERY_TOPIC,JSON.stringify({timestamp:Date.now(),technics:t,economics:n,promisee:(0,G.m)(T.accountManager.account.address,32),promisee_signature:{[T.accountManager.account.type.toUpperCase()]:i}}));console.log("pubsub publish",r.toHuman()),r.toHuman()||(this.errorBurn="Error: Message not sent",this.isLoadBurn=!1,a())},async signData(t,e){const{data:n}=T.liability.getDataLiability(t,e);return(await T.accountManager.account.signMsg((0,F.d)(n))).toString()}}};const tt=(0,P.Z)(X,[["render",Q]]);var et=tt,nt={data(){return{connectMultiaddr:K.CONNECT_MULTIADDR}},watch:{connectMultiaddr(){this.connect()}},created(){this.connect()},methods:{async connect(){try{const t=await T.api.rpc.pubsub.connect(this.connectMultiaddr);console.log("pubsub connect",this.connectMultiaddr,t.toHuman())}catch(t){console.log("pubsub connect",this.connectMultiaddr,t.message)}}}};const it=nt;var at=it,rt={components:{Account:R,Pubsub:at,Energy:et}};const ot=(0,P.Z)(rt,[["render",u]]);var st=ot,ct={components:{Page:st},data(){return{isReady:!1}},async created(){await T.run(),this.isReady=!0}};const ut=(0,P.Z)(ct,[["render",c]]);var lt=ut,dt={install:t=>{t.config.globalProperties.$filters={date(t){return t?new Date(t).toLocaleDateString():"-"}}}},pt=n(2353);class ht{constructor(t){this.endpoint=t}auth(t,e){const n=`sub-${t}:${e}`;this.authHeader=i.lW.from(n).toString("base64")}authClear(){this.authHeader=null}async add(t){const e=(0,pt.Ue)({url:this.endpoint,headers:{authorization:`Basic ${this.authHeader}`}}),{cid:n}=await e.add(t);return n.toString()}async cat(t){const e=new TextDecoder,n=(0,pt.Ue)({url:this.endpoint,headers:{authorization:`Basic ${this.authHeader}`}});let i="";for await(const r of n.cat(t))i+=e.decode(r,{stream:!0});try{return JSON.parse(i)}catch(a){return i}}}var gt={install:t=>{t.config.globalProperties.$ipfs=new ht(K.GATEWAY)}};window.Buffer=i.lW;const bt=(0,a.ri)(lt);bt.use(dt).use(gt).mount("#app")},5856:function(){},6601:function(){},3897:function(){},5024:function(){}},e={};function n(i){var a=e[i];if(void 0!==a)return a.exports;var r=e[i]={id:i,loaded:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}n.m=t,function(){n.amdO={}}(),function(){var t=[];n.O=function(e,i,a,r){if(!i){var o=1/0;for(l=0;l<t.length;l++){i=t[l][0],a=t[l][1],r=t[l][2];for(var s=!0,c=0;c<i.length;c++)(!1&r||o>=r)&&Object.keys(n.O).every((function(t){return n.O[t](i[c])}))?i.splice(c--,1):(s=!1,r<o&&(o=r));if(s){t.splice(l--,1);var u=a();void 0!==u&&(e=u)}}return e}r=r||0;for(var l=t.length;l>0&&t[l-1][2]>r;l--)t[l]=t[l-1];t[l]=[i,a,r]}}(),function(){n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,{a:e}),e}}(),function(){var t,e=Object.getPrototypeOf?function(t){return Object.getPrototypeOf(t)}:function(t){return t.__proto__};n.t=function(i,a){if(1&a&&(i=this(i)),8&a)return i;if("object"===typeof i&&i){if(4&a&&i.__esModule)return i;if(16&a&&"function"===typeof i.then)return i}var r=Object.create(null);n.r(r);var o={};t=t||[null,e({}),e([]),e(e)];for(var s=2&a&&i;"object"==typeof s&&!~t.indexOf(s);s=e(s))Object.getOwnPropertyNames(s).forEach((function(t){o[t]=function(){return i[t]}}));return o["default"]=function(){return i},n.d(r,o),r}}(),function(){n.d=function(t,e){for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){n.nmd=function(t){return t.paths=[],t.children||(t.children=[]),t}}(),function(){var t={143:0};n.O.j=function(e){return 0===t[e]};var e=function(e,i){var a,r,o=i[0],s=i[1],c=i[2],u=0;if(o.some((function(e){return 0!==t[e]}))){for(a in s)n.o(s,a)&&(n.m[a]=s[a]);if(c)var l=c(n)}for(e&&e(i);u<o.length;u++)r=o[u],n.o(t,r)&&t[r]&&t[r][0](),t[r]=0;return n.O(l)},i=self["webpackChunkdapp_smart_building_offsetting"]=self["webpackChunkdapp_smart_building_offsetting"]||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))}();var i=n.O(void 0,[998],(function(){return n(566)}));i=n.O(i)})();
//# sourceMappingURL=app.6dacc063.js.map